<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AgriTrio Mobile Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --primary:#2563eb;
    --primary-dark:#1d4ed8;
    --bg:#f1f5f9;
    --text:#1e293b;
    --card:#fff;
    --card-hover:#f3f4f6;
  }
  [data-theme="dark"]{
    --bg:#1e293b;
    --text:#f1f5f9;
    --card:#334155;
    --card-hover:#475569;
  }
  body { font-family: 'Inter', sans-serif; margin:0; background:var(--bg); color:var(--text); transition: all 0.3s; }
  header { background: linear-gradient(90deg,var(--primary),var(--primary-dark)); color:white; padding:15px 20px; font-size:1.5em; }
  .container { display:flex; flex-direction:column; min-height:100vh; }
  nav { display:flex; overflow-x:auto; background:var(--card); }
  nav button { flex:1; padding:12px; border:none; background:transparent; cursor:pointer; color:var(--text); font-weight:500; transition:0.2s; border-bottom:2px solid transparent; }
  nav button.active { border-bottom:2px solid var(--primary); }
  main { flex:1; padding:15px; }
  .card { background:var(--card); border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:15px; margin-bottom:15px; transition: all 0.3s; }
  .card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.15);}
  .btn { padding:10px 15px; border-radius:6px; border:none; cursor:pointer; margin:5px 0; transition:0.2s; width:100%; }
  .btn-primary { background:var(--primary); color:white; }
  .btn-primary:hover { background:var(--primary-dark); }
  table { width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9em; }
  th,td { border:1px solid #e2e8f0; padding:8px; text-align:center; }
  th { background:#f9fafb; }
  select,input,textarea { width:100%; padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
  .collapsible { background:var(--primary); color:white; cursor:pointer; padding:10px; width:100%; border:none; text-align:left; outline:none; font-size:1em; border-radius:6px; margin-bottom:5px; }
  .activeCollapsible, .collapsible:hover { background:var(--primary-dark); }
  .content { padding:0 15px; display:none; overflow:hidden; background-color:var(--card-hover); border-radius:6px; margin-bottom:10px; }
  .ai-box { border:1px solid #ccc; border-radius:6px; padding:5px; height:200px; overflow-y:auto; margin-bottom:5px; background:var(--card-hover); }
</style>
</head>
<body>
<header>üå± AgriTrio ‚Äì AI Agriculture Assistant</header>

<!-- Navigation -->
<nav>
  <button onclick="showSection('overview')" class="active">üè† Overview</button>
  <button onclick="showSection('climate')">üå§ Climate</button>
  <button onclick="showSection('market')">üìä Market</button>
  <button onclick="showSection('education')">üìö Education</button>
  <button onclick="showSection('aiSection')">ü§ñ AI</button>
  <button onclick="showSection('settings')">‚öôÔ∏è Settings</button>
</nav>

<main>
  <!-- Overview -->
  <section id="overview" class="section">
    <div class="card">
      <h2>Dashboard Overview</h2>
      <p>AgriTrio helps farmers with <b>real-time climate reports</b>, <b>dynamic crop prices</b>, and <b>AI-assisted learning</b> about agriculture practices.</p>
    </div>
    <div class="card">
      <canvas id="trendChart" height="120"></canvas>
    </div>
  </section>

  <!-- Climate -->
  <section id="climate" class="section" style="display:none;">
    <div class="card">
      <h2>Climate Report (Live)</h2>
      <p id="weatherData">Loading weather...</p>
    </div>
  </section>

  <!-- Market -->
  <section id="market" class="section" style="display:none;">
    <div class="card">
      <h2>Market Prices (Agmarknet Live)</h2>
      <select id="commoditySelect"></select>
      <select id="stateSelect"></select>
      <input type="text" id="marketInput" placeholder="Market name"/>
      <button class="btn btn-primary" onclick="loadMarketLive()">Fetch Prices</button>
      <table id="priceTable">
        <tr><th>Commodity</th><th>Market</th><th>Min</th><th>Max</th><th>Modal</th><th>Date</th></tr>
      </table>
    </div>
  </section>

  <!-- Education -->
  <section id="education" class="section" style="display:none;">
    <div class="card">
      <h2>üìö Agriculture Education Hub</h2>
      <button class="collapsible">1Ô∏è‚É£ Land & Soil</button>
      <div class="content">
        <ul><li>Soil Types: Clay, Loam, Sandy, Alluvial, Black Soil.</li><li>Soil Testing: pH, nutrients.</li></ul>
      </div>
      <button class="collapsible">2Ô∏è‚É£ Irrigation & Water</button>
      <div class="content">
        <ul><li>Drip, Sprinkler, Flood irrigation.</li><li>Rainwater harvesting & water conservation.</li></ul>
      </div>
      <button class="collapsible">3Ô∏è‚É£ Farming Methods</button>
      <div class="content"><ul><li>Organic, Hybrid, Precision, Hydroponics, Aqua Farming</li></ul></div>
      <button class="collapsible">4Ô∏è‚É£ Crop Management</button>
      <div class="content"><ul><li>Crop rotation & mixed cropping.</li><li>IPM & NPK balance.</li></ul></div>
    </div>
  </section>

  <!-- AI Assistant -->
  <section id="aiSection" class="section" style="display:none;">
    <div class="card">
      <h2>ü§ñ AI Assistant</h2>
      <div class="ai-box" id="chatBox"></div>
      <textarea id="aiInput" rows="2" placeholder="Ask about crops, diseases, fertilizers..."></textarea>
      <button class="btn btn-primary" onclick="queryAI()">Send</button>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="section" style="display:none;">
    <div class="card">
      <h2>‚öôÔ∏è Settings</h2>
      <button class="btn" onclick="toggleTheme()">Toggle Dark/Light Theme</button>
      <div style="margin-top:10px;">
        <h3>About App</h3>
        <p>AgriTrio v1.0 ‚Äì AI-powered mobile dashboard for agriculture monitoring and education.</p>
        <h3>Contact Us</h3>
        <p>Email: support@agritrio.com | Phone: +91-9000000000</p>
      </div>
    </div>
  </section>
</main>

<script>
// Navigation
function showSection(id){
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
  event.target.classList.add('active');
}

// Theme Toggle
function toggleTheme(){
  document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
}

// --- Weather ---
async function loadWeather(){
  try{
    let res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=12.3&longitude=76.6&current_weather=true");
    let d = await res.json();
    let w = d.current_weather;
    const weatherStr = `üå° ${w.temperature}¬∞C üí® ${w.windspeed} km/h`;
    document.getElementById("weatherData").innerText = weatherStr;
    localStorage.setItem("weatherCache", JSON.stringify({data: weatherStr, ts: Date.now()}));
    notifyUser("Weather Update", weatherStr);
  }catch(e){
    const cache = JSON.parse(localStorage.getItem("weatherCache"));
    document.getElementById("weatherData").innerText = cache?.data || "Weather unavailable offline";
  }
}

// --- Commodities & States ---
const commodities=["Wheat","Rice","Maize","Barley","Millets","Mustard","Soybean","Cotton","Sugarcane","Groundnut","Onion","Potato","Tomato","Banana","Apple","Mango","Turmeric","Chilli","Lentil","Chickpea","Coconut","Tea","Coffee"];
const states=["Karnataka","Maharashtra","Punjab","Haryana","Uttar Pradesh","Madhya Pradesh","Tamil Nadu","Andhra Pradesh","Gujarat","West Bengal","Bihar"];
function populateDropdowns(){
  const cSelect=document.getElementById("commoditySelect");
  const sSelect=document.getElementById("stateSelect");
  commodities.forEach(c=>{let o=document.createElement("option"); o.value=c;o.text=c;cSelect.appendChild(o);});
  states.forEach(s=>{let o=document.createElement("option"); o.value=s;o.text=s;sSelect.appendChild(o);});
}

// --- Agmarknet Fetch ---
async function fetchAgmarknetPrice(commodity,state,market){
  try{
    const apiUrl=`https://agmarknetapi.herokuapp.com/request?commodity=${encodeURIComponent(commodity)}&state=${encodeURIComponent(state)}&market=${encodeURIComponent(market)}`;
    const resp = await fetch(apiUrl);
    if(!resp.ok) throw new Error("Bad response");
    return await resp.json();
  }catch(err){
    const fallback = [{Commodity:commodity,City:market,"Min Prize":2000,"Max Prize":2400,"Model Prize":2200,Date:new Date().toLocaleDateString()}];
    return fallback;
  }
}

async function loadMarketLive(){
  const c=document.getElementById("commoditySelect").value;
  const s=document.getElementById("stateSelect").value;
  const m=document.getElementById("marketInput").value || "Default Market";
  const table=document.getElementById("priceTable");
  table.querySelectorAll("tr:not(:first-child)").forEach(r=>r.remove());

  try{
    const data = await fetchAgmarknetPrice(c,s,m);
    localStorage.setItem("marketCache", JSON.stringify({data, ts:Date.now()}));
    populateMarketTable(data);
    notifyUser("Market Update", `${c} modal price: ${data[0]["Model Prize"]}`);
  }catch(e){
    const cache = JSON.parse(localStorage.getItem("marketCache"));
    if(cache?.data) populateMarketTable(cache.data);
    else alert("No market data available offline");
  }
}

function populateMarketTable(data){
  const table=document.getElementById("priceTable");
  data.forEach(rec=>{
    const r=table.insertRow();
    r.insertCell(0).innerText=rec["Commodity"];
    r.insertCell(1).innerText=rec["City"];
    r.insertCell(2).innerText=rec["Min Prize"];
    r.insertCell(3).innerText=rec["Max Prize"];
    r.insertCell(4).innerText=rec["Model Prize"];
    r.insertCell(5).innerText=rec["Date"];
  });
}

// --- Chart ---
function renderChart(){
  const ctx=document.getElementById("trendChart");
  new Chart(ctx,{type:"line",data:{
    labels:["Jan","Feb","Mar","Apr","May"],
    datasets:[
      {label:"Wheat",data:[2200,2250,2300,2400,2450],borderColor:"#2563eb",fill:false,tension:0.3},
      {label:"Rice",data:[3000,3100,3050,3150,3200],borderColor:"#16a34a",fill:false,tension:0.3},
      {label:"Maize",data:[1800,1850,1900,1950,2000],borderColor:"#f59e0b",fill:false,tension:0.3}
    ]
  }, options:{plugins:{tooltip:{mode:'index',intersect:false}}}});
}

// --- Collapsible Education ---
document.addEventListener("DOMContentLoaded", function(){
  const coll=document.getElementsByClassName("collapsible");
  for(let i=0;i<coll.length;i++){
    coll[i].addEventListener("click",function(){
      this.classList.toggle("activeCollapsible");
      const content=this.nextElementSibling;
      content.style.display = content.style.display==="block"?"none":"block";
    });
  }
});

// --- Push Notifications ---
if("Notification" in window){Notification.requestPermission();}
function notifyUser(title, body){if(Notification.permission==="granted"){new Notification(title,{body});}}

// --- AI Chat ---
let chatHistory = [];
async function queryAI(){
  const input=document.getElementById("aiInput").value.trim();
  if(!input) return;
  const chatBox=document.getElementById("chatBox");
  chatHistory.push({role:"user", text: input});
  renderChat();
  document.getElementById("aiInput").value="";

  try{
    const response = await fetch("https://api-inference.huggingface.co/models/gpt2", {
      method:"POST",
      headers:{ "Authorization":"Bearer hf_your_open_source_token_here","Content-Type":"application/json"},
      body: JSON.stringify({inputs: input})
    });
    const data = await response.json();
    const aiText = data[0]?.generated_text || "AI did not respond.";
    chatHistory.push({role:"ai", text: aiText});
    renderChat();
  }catch(e){chatHistory.push({role:"ai", text:"AI API unavailable."}); renderChat();}
}

function renderChat(){
  const chatBox=document.getElementById("chatBox");
  chatBox.innerHTML="";
  chatHistory.forEach(msg=>{
    const div=document.createElement("div");
    div.style.padding="5px";
    div.style.margin="3px 0";
    div.style.borderRadius="5px";
    if(msg.role==="user"){div.style.background="#2563eb"; div.style.color="white"; div.style.textAlign="right";}
    else{div.style.background="#e2e8f0"; div.style.color="#1e293b"; div.style.textAlign="left";}
    div.innerText = msg.text;
    chatBox.appendChild(div);
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

// --- Init ---
window.onload = ()=>{
  populateDropdowns();
  loadWeather();
  renderChart();
}
</script>
</body>
</html>
